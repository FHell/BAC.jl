var documenterSearchIndex = {"docs":
[{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"EditURL = \"<unknown>/examples/simple_graph_example.jl\"","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"using BAC\n\nusing Random\nusing Plots\nRandom.seed!(42);\nusing GraphPlot\nusing DiffEqFlux\n\ndim_sys = 10\n\nbac_10 = BAC.create_graph_example(dim_sys, 3, 0.:0.1:10., 10)","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"we can easily plot the input samples and system layouts","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"plot(0:0.01:10, bac_10.input_sample, c=:gray, alpha=1, legend=false)\nBAC.plot_sys_graph(bac_10)","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"a nonlinear diffusively coupled graph system. Specification is a two node version of the graph. => Can we make a large graph react like a small graph by tuning the non-linearity at the nodes?","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"p_initial = ones(2*10+dim_sys)\n\n# Finished initialization","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"bac_1 implements the loss function. We are looking for parameters that minimize it, it can be evaluated directly on a parameter array:","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"l = bac_10(p_initial) # 1713\nl = bac_10(p_initial; abstol=1e-2, reltol=1e-2) # 1868","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"Plot callback plots the solutions passed to it:","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"samples = 1:3 # we can choose what samples to use for plots everywhere\nBAC.plot_callback(bac_10, p_initial, l, input_sample=samples)\n\nlosses = zeros(0) # for plotting loss change over the course of optimization","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"Underlying the loss function is the output metric comparing the two trajectories:","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"sol1, sol2 = solve_bl_n(bac_10, 3, p_initial, input_sample=samples)\nbac_10.output_metric(sol1, sol2)","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"We can get all the individual contributions with","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"il = individual_losses(bac_10, p_initial)","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"Train with 10 samples, low accuracy and relatively large ADAM step size: (1.5 minutes on my Laptop)","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"@time res_10 = DiffEqFlux.sciml_train(\n    p -> bac_10(p; abstol=1e-2, reltol=1e-2),\n    p_initial,\n    DiffEqFlux.ADAM(0.5),\n    maxiters = 5,\n    #cb = basic_bac_callback\n    cb = (p, l) -> plot_callback(bac_10, p, l, input_sample=samples)\n    )\n\nplot_callback(bac_10, res_10.minimizer, l, input_sample = 1:3)","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"Train with 10 samples, medium accuracy and still large ADAM step size:","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"@time res_10 = DiffEqFlux.sciml_train(\n    p -> bac_10(p; abstol=1e-6, reltol=1e-6),\n    res_10.minimizer,\n    DiffEqFlux.ADAM(0.5),\n    maxiters = 20,\n    #cb = basic_bac_callback\n    cb = (p, l) -> plot_callback(bac_10, p, l, input_sample = samples)\n    )\n\n@time res_10 = DiffEqFlux.sciml_train(\n    p -> bac_10(p),\n    res_10.minimizer,\n    DiffEqFlux.ADAM(0.5),\n    maxiters = 20,\n    cb = basic_bac_callback","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"cb = (p, l) -> plotcallback(bac10, p, l, input_sample=samples)","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"    )\n\nplot_callback(bac_10, res_10.minimizer, l; input_sample=samples, fig_name = \"../graphics/opt_123-10_l$(l)_axis.png\")","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"this got it down to 0.01 loss. we can look at the minimizer: p_sys","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"res_10.minimizer[1:dim_sys] |> relu |> println","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"p_spec","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"res_10.minimizer[dim_sys+1:end] |> relu |> println","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"After a few runs of the above code block (trying both larger and smaller ADAM step sizes) I get this down to < 0.3 At this point I don't really care about going further as we are probably overfitting to the small sample.","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"We can check the quality of the resulting minimizer by optimizing the specs only (a much simpler repeated 2d optimization problem)","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"p2 = bac_spec_only(bac_10, res_10.minimizer)\nlosses = individual_losses(bac_10, p2)\nmedian(losses) #0.02","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"In order to understand how much we were overfitting with respect to the concrete sample, we resample That is, we generate a new problem with a new sample from the same distribution:","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"bac_10_rs = resample(rand_fourier_input_generator, bac_10)\np3 = bac_spec_only(bac_10_rs, res_10.minimizer)\nlosses_rs = individual_losses(bac_10_rs, p3)\nmedian(losses_rs) #0.04","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"This will give us information on the system tuning with a sample different from the one that the tuning was optimized for.","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"# Larger number of samples","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"We warmed up the optimization with a very small number of samples, we can now initialize a higher sampled optimization using the system parameters found in the lower one:","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"p_100 = ones(2*100+dim_sys)\np_100[1:dim_sys] .= res_10.minimizer[1:dim_sys]\np_100[dim_sys+1:end] .= repeat(res_10.minimizer[dim_sys+1:dim_sys+2], 100)\n\nbac_100 = resample(rand_fourier_input_generator, bac_10; n = 100)","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"Optimizing only the specs is a task linear in the number of samples, the idea is that this will help with warming up the optimization We can also study the quality of the tuning found by the optimization based on a small number of Samples","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"p_100_initial = bac_spec_only(bac_100, p_100;\n                    optimizer=DiffEqFlux.ADAM(0.1),\n                    optimizer_options=(:maxiters => 10,),\n                    abstol = 1e-3, reltol=1e-3)\nlosses_100_initial = individual_losses(bac_100, p_100_initial)","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"Todo: Indication of bug or not completely understood behaviour!!","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"median(losses_100_initial) # This is much larger (factor 5-10) than the losses_10_rs version. It shouldn't be. Needs to be investigated!!!!!","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"Possibility: THe optimization in bacspeconly is not doing its job very well, switch to ADAM?","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"plot_callback(bac_100, p_100_initial, l, input_sample = samples)","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"Train the full system:","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"@time   res_100 = DiffEqFlux.sciml_train(\n    bac_100,\n    p_100_initial,","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"DiffEqFlux.ADAM(0.5),","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"    DiffEqFlux.BFGS(initial_stepnorm = 0.01),\n    maxiters = 5,\n    cb = basic_bac_callback\n    )","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"Continue improving it for 50 Steps with some plotting in between:","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"for i in 1:10\n    global res_100\n    res_100 = DiffEqFlux.sciml_train(\n        bac_100,\n        relu.(res_100.minimizer),\n        DiffEqFlux.ADAM(0.1),","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"DiffEqFlux.BFGS(initial_stepnorm = 0.01),","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"        maxiters = 5,\n        cb = basic_bac_callback\n        )\n    l = bac_100(res_100.minimizer);\n    plot_callback(bac_100, res_100.minimizer, l, input_sample = 50:52, fig_name = \"../graphics/res_100_int\"*string(i, pad = 2)#=;ylims = (-0.5,0.5)=#)\nend","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"","category":"page"},{"location":"generated/simple_graph_example.html","page":"Simple graph example","title":"Simple graph example","text":"This page was generated using Literate.jl.","category":"page"}]
}
