<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Simple graph example · BAC.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://fhell.github.io/BAC.jl/generated/simple_graph_example/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.039/juliamono-regular.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">BAC.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Examples</span><ul><li class="is-active"><a class="tocitem" href>Simple graph example</a><ul class="internal"><li><a class="tocitem" href="#Simple-graph-example"><span>Simple graph example</span></a></li><li><a class="tocitem" href="#Finished-initialization"><span>Finished initialization</span></a></li><li><a class="tocitem" href="#Larger-number-of-samples"><span>Larger number of samples</span></a></li></ul></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>Simple graph example</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Simple graph example</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/FHell/BAC.jl/blob/master/examples/simple_graph_example.jl" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><pre><code class="language- hljs">using BAC

using Random
using Plots
Random.seed!(42);
using GraphPlot
using DiffEqFlux
using Pipe: @pipe
using Statistics
using LaTeXStrings</code></pre><h2 id="Simple-graph-example"><a class="docs-heading-anchor" href="#Simple-graph-example">Simple graph example</a><a id="Simple-graph-example-1"></a><a class="docs-heading-anchor-permalink" href="#Simple-graph-example" title="Permalink"></a></h2><p>As an example we want to tune a system of 10 nodes with one grid connection point to a specification of 2 nodes.</p><p>Our goal is to find such parameters for the 10-node system that it behaves close enough to a 2-node system under all possible inputs. In this example we start with just 10 possible inputs.</p><pre><code class="language- hljs">dim_sys = 10
bac_10 = BAC.create_graph_example(dim_sys, 3, 0.:0.1:10., 10);
nothing #hide</code></pre><p>We can plot the input trajectories and system layouts. Optimized system is a nonlinear diffusively coupled graph system. Specification is a two node version of the graph.</p><pre><code class="language- hljs">plot(0:0.01:10, bac_10.scenario_nums, c=:gray, alpha=1, legend=false)
BAC.plot_sys_graph(bac_10)</code></pre><p>=&gt; Can we make a large graph react like a small graph by tuning the non-linearity at the nodes?</p><pre><code class="language-julia hljs">p_initial = ones(2*10+dim_sys)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">30-element Array{Float64,1}:
 1.0
 1.0
 1.0
 1.0
 1.0
 1.0
 1.0
 1.0
 1.0
 1.0
 ⋮  
 1.0
 1.0
 1.0
 1.0
 1.0
 1.0
 1.0
 1.0
 1.0</code></pre><h2 id="Finished-initialization"><a class="docs-heading-anchor" href="#Finished-initialization">Finished initialization</a><a id="Finished-initialization-1"></a><a class="docs-heading-anchor-permalink" href="#Finished-initialization" title="Permalink"></a></h2><p>bac_10 implements the loss function. We are looking for parameters that minimize it. It can be evaluated directly on a parameter array:</p><pre><code class="language- hljs">l = bac_10(p_initial; abstol=1e-2, reltol=1e-2)</code></pre><p>Plot callback plots the solutions passed to it. We choose which scenarios to use for plots, as plotting for all scenarios makes visual results harder to understand.</p><pre><code class="language- hljs">scenarios = 1:3 # we can choose what scnearios to use for plots everywhere
BAC.plot_callback(bac_10, p_initial, l, scenario_nums=scenarios, fig_name = &quot;graphics/initial10_$(l).png&quot;)

#losses = zeros(0) # for plotting loss change over the course of optimization</code></pre><p>Underlying the loss function is the output metric comparing the two trajectories:</p><pre><code class="language- hljs">sol1, sol2 = solve_bl_n(bac_10, 3, p_initial, scenario_nums=scenarios)
bac_10.output_metric(sol1, sol2)

#= We can get all the individual contributions with individual_losses:=#
il = individual_losses(bac_10, p_initial)

#= Training with 10 scenarios, low accuracy and relatively large ADAM step size is a way to quickly get a good approximation, that can then be improved by increasing accuracy and number of samples.
=#
@time res_10 = DiffEqFlux.sciml_train(
    p -&gt; bac_10(p; abstol=1e-2, reltol=1e-2),
    p_initial,
    DiffEqFlux.ADAM(0.5),
    maxiters = 5,
    cb = (p, l) -&gt; plot_callback(bac_10, p, l, scenario_nums=scenarios)
    )

plot_callback(bac_10, res_10.minimizer, l, scenario_nums = 1:3)

@time res_10 = DiffEqFlux.sciml_train(
    p -&gt; bac_10(p; abstol=1e-6, reltol=1e-6),
    res_10.minimizer,
    DiffEqFlux.ADAM(0.5),
    maxiters = 20,
    cb = (p, l) -&gt; plot_callback(bac_10, p, l, scenario_nums = scenarios)
    )

@time res_10 = DiffEqFlux.sciml_train(
    p -&gt; bac_10(p),
    res_10.minimizer,
    DiffEqFlux.ADAM(0.5),
    maxiters = 20,
    cb = basic_bac_callback
    )

plot_callback(bac_10, res_10.minimizer, l; scenario_nums=scenarios)</code></pre><p>After getting a good initial approximation, we can look at the minimizer. Going further makes little sense as we would be overfitting to the small sample.</p><pre><code class="language- hljs">res_10.minimizer[1:dim_sys] |&gt; BAC.relu |&gt; println #p_sys
res_10.minimizer[dim_sys+1:end] |&gt; BAC.relu |&gt; println #p_spec

#= ## Resampling
We can check the quality of the resulting minimizer by optimizing the specs only (a much simpler repeated 2d optimization problem)
=#
p2 = bac_spec_only(bac_10, res_10.minimizer)
losses = individual_losses(bac_10, p2)
median(losses)</code></pre><p>In order to understand how much we were overfitting with respect to the concrete sample, we resample. That is, we generate a new problem with a new sample from the same distribution: This will give us information on the system tuning with a sample different from the one that the tuning was optimized for.</p><pre><code class="language- hljs">bac_10_rs = resample(BAC.rand_fourier_input_generator, bac_10);
p3 = bac_spec_only(bac_10_rs, res_10.minimizer)
losses_rs = individual_losses(bac_10_rs, p3)
median(losses_rs)</code></pre><p>The median individual loss has gone up by a factor of 4. This means that the system is somewhat overfit to the initial sample.</p><h2 id="Larger-number-of-samples"><a class="docs-heading-anchor" href="#Larger-number-of-samples">Larger number of samples</a><a id="Larger-number-of-samples-1"></a><a class="docs-heading-anchor-permalink" href="#Larger-number-of-samples" title="Permalink"></a></h2><p>We warmed up the optimization with a very small number of scenarios, we can now initialize a higher sampled optimization using the system parameters found in the lower one:</p><pre><code class="language- hljs">p_100 = ones(2*100+dim_sys)
p_100[1:dim_sys] .= res_10.minimizer[1:dim_sys]
p_100[dim_sys+1:end] .= repeat(res_10.minimizer[dim_sys+1:dim_sys+2], 100)

bac_100 = resample(BAC.rand_fourier_input_generator, bac_10; n = 100);
nothing #hide</code></pre><p>Optimizing only the specs is a task linear in the number of scenarios, the idea is that this will help with warming up the optimization. We can also study the quality of the tuning found by the optimization based on a small number of samples.</p><pre><code class="language- hljs">p_100_initial = bac_spec_only(bac_100, p_100;
                    optimizer=DiffEqFlux.ADAM(0.1),
                    optimizer_options=(:maxiters =&gt; 10,),
                    abstol = 1e-3, reltol=1e-3)
losses_100_initial = individual_losses(bac_100, p_100_initial)
median(losses_100_initial)
plot_callback(bac_100, p_100_initial, l, scenario_nums = scenarios)

#= Now we can train the full system:
=#
@time   res_100 = DiffEqFlux.sciml_train(
    bac_100,
    p_100_initial,</code></pre><p>DiffEqFlux.ADAM(0.5),</p><pre><code class="language- hljs">    DiffEqFlux.BFGS(initial_stepnorm = 0.01),
    maxiters = 5,
    cb = basic_bac_callback
    )

#= Continue improving it for 150 Steps with some plotting in between:=#
for i in 1:30
    global res_100
    res_100 = DiffEqFlux.sciml_train(
        bac_100,
        relu.(res_100.minimizer),
        DiffEqFlux.ADAM(0.1),</code></pre><p>DiffEqFlux.BFGS(initial_stepnorm = 0.01),</p><pre><code class="language- hljs">        maxiters = 5,
        cb = basic_bac_callback
        )
    l = bac_100(res_100.minimizer);
    plot_callback(bac_100, res_100.minimizer, l, scenario_nums = scenarios)
end

plot_callback(bac_10, res_10.minimizer, l; scenario_nums=scenarios)

losses = individual_losses(bac_100, res_100.minimizer)

x= exp10.(range(log10(.05),stop=log10(0.4), length = 50))
plot(x, (x)-&gt;1-confidence_interval(losses, x)[1],
    xlabel = &quot;ε&quot;, ylabel=L&quot;\hat d^{\rho,\varepsilon}&quot;,legend=:bottomright, label=false,c=:blue)
    #label=&quot;Fraction of scenarios within set distance from specification&quot;)
    plot!(x, (x)-&gt;1-confidence_interval(losses, x)[2],
        xlabel = &quot;ε&quot;, ylabel=L&quot;\hat d^{\rho,\varepsilon}&quot;,legend=:bottomright, label=false, linestyle=:dash, c=:blue)
        #label=&quot;Fraction of scenarios within set distance from specification&quot;)
    plot!(x, (x)-&gt;1-confidence_interval(losses, x)[3],
        xlabel = &quot;ε&quot;, ylabel=L&quot;\hat d^{\rho,\varepsilon}&quot;,legend=:bottomright, label=false, linestyle=:dash, c=:blue)
        #label=&quot;Fraction of scenarios within set distance from specification&quot;)

plot(sort!(losses),[1:length(losses)]./length(losses), label = false)

plot(sort!(losses),[1:length(losses)]./length(losses), label = false)</code></pre><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../">« Home</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.5 on <span class="colophon-date" title="Wednesday 25 August 2021 16:31">Wednesday 25 August 2021</span>. Using Julia version 1.3.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
